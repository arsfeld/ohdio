services:
  phoenix:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ohdio-phoenix-dev
    ports:
      - "4001:4000"  # Phoenix web server (mapped to 4001 to avoid conflict)
    volumes:
      # Mount source code for hot-reloading
      - .:/app
      # Single config directory for all persistent data (linuxserver.io convention)
      - ./config:/config
    environment:
      # Phoenix configuration
      - PHX_HOST=localhost
      - PORT=4000
      - MIX_ENV=dev
      # User/Group IDs (linuxserver.io convention)
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      # Database configuration (SQLite)
      - DATABASE_PATH=/config/db/ohdio_dev.db
      # Storage paths
      - STORAGE_PATH=/config/downloads
      - LOG_PATH=/config/logs
      # Download configuration
      - DOWNLOAD_DIR=/config/downloads
      - MAX_CONCURRENT_DOWNLOADS=3
      - MIN_DISK_SPACE_MB=100
      - MAX_FILE_SIZE_MB=0
    working_dir: /app
    command: bash -c "mix deps.get && mix ecto.create && mix ecto.migrate && mix phx.server"
    stdin_open: true
    tty: true
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

networks:
  default:
    name: ohdio-phoenix-network
